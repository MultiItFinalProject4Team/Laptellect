<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.w3.org/1999/xhtml"
      layout:decorate="~{common/layout}">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" th:href="@{/css/product/product.css}">
    <script th:inline="javascript">
        $(document).ready(function() {
            let currentPage = 1;
            let pageSize = 20;
            let typeNo = 1;
            let currentKeyword = '';

            // 기본 탭에 active 클래스 추가
            switch(typeNo) {
                case 1:
                    $("#laptop-tab").addClass("active");
                    break;
                case 2:
                    $("#mouse-tab").addClass("active");
                    break;
                case 3:
                    $("#keyboard-tab").addClass("active");
                    break;
                default:
                    $("#laptop-tab").addClass("active");
                    break;
            }

            // 가격 형식을 포맷팅하는 함수
            function formatPrices() {
                $('.price').each(function() {
                    let value = $(this).text().replace(' 원', '').replace(/,/g, '');
                    let formattedValue = new Intl.NumberFormat().format(value);
                    $(this).text(formattedValue + ' 원');
                });
            }

            // 필터 값을 카테고리별로 수집하는 함수
            function getSelectedFiltersByCategory(categoryName) {
                let filters = [];
                $("#filterForm input[name='" + categoryName + "']:checked").each(function() {
                    filters.push($(this).val());
                });
                return filters;
            }

            // 필터 값이 변경될 때 호출
            $("#filterForm input:checkbox").on("change", function() {
                loadProducts(0, 10, 1);
            });

            // 검색 폼 제출 시 호출
            $("#searchForm").on("submit", function(e) {
                searchProducts(0, 10, 1);
            });

            // 제품 리스트를 로드하는 함수
            function loadProducts(page, size, typeNo) {
                let data = {
                    page: page,
                    size: size,
                    typeNo: typeNo,
                    keyword: $("#form1").val(),
                    LBI1: getSelectedFiltersByCategory('os'),
                    LBI2: getSelectedFiltersByCategory('manufacturer'),
                    LS22: getSelectedFiltersByCategory('storageType'),
                    LS21: getSelectedFiltersByCategory('storageCapacity'),
                    LG38: getSelectedFiltersByCategory('gpu'),
                    LC13: getSelectedFiltersByCategory('cpu'),
                    LR9: getSelectedFiltersByCategory('ram'),
                    LD25: getSelectedFiltersByCategory('resolution'),
                    min: $("#site-search1").val(), // 최소 가격
                    max: $("#site-search2").val()  // 최대 가격
                };

                console.log("Calling loadProducts with - data:", data);

                $.ajax({
                    url: "/api/product/product-list",
                    type: "GET",
                    data: data,
                    success: function(response) {
                        $('#product-list').html(response);
                        formatPrices();
                        currentPage = page;
                    },
                    error: function(error) {
                        console.log(error);
                    }
                });
            }

            // 필터와 검색어로 제품을 검색하는 함수
            function searchProducts() {
                let keyword = $("#form1").val();

                let LBI1 = getSelectedFiltersByCategory('os');
                let LBI2 = getSelectedFiltersByCategory('manufacturer');
                let LS22 = getSelectedFiltersByCategory('storageType');
                let LS21 = getSelectedFiltersByCategory('storageCapacity');
                let LG38 = getSelectedFiltersByCategory('gpu');
                let LC13 = getSelectedFiltersByCategory('cpu');
                let LR9 = getSelectedFiltersByCategory('ram');
                let LD25 = getSelectedFiltersByCategory('resolution');

                loadProducts(currentPage, pageSize, typeNo;
            }

            // 페이지 로드 시 초기 제품 리스트 로드
            searchProducts();

            // 탭 클릭 시 발생하는 이벤트 핸들러
            $(".product-link").on("click", function(e) {
                e.preventDefault();
                typeNo = $(this).data('type-no');
                currentPage = 1;
                $(".product-link").removeClass("active");
                $(this).addClass("active");
                searchProducts();
            });

            // 페이지 링크 클릭 시 발생하는 이벤트 핸들러
            $(document).on('click', '.pagination a.page-link', function(event) {
                event.preventDefault();

                let page = $(this).data('page');
                if (!$(this).closest('li').hasClass('disabled') && !$(this).closest('li').hasClass('active')) {
                    currentPage = page;
                    searchProducts();
                }
            });
        });
    </script>

    <style>
        /* 스타일 정의 */
        .left-align {
            text-align: left;
        }
        .filter-header {
            width: 100px;
        }
        .options-list {
            display: flex;
            flex-wrap: wrap;
        }
        .options-list label {
            margin-right: 10px;
        }
        .btn-custom-price {
            background-color: #3498DB;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 10px 20px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
    </style>
</head>

<body>
<div class="container-md" layout:fragment="content">
    <br>
    <form id="filterForm">
        <table border="1">
            <tbody class="table custom-table custom-table-striped custom-table-bordered custom-table-hover">
            <!-- 제조사 -->
            <tr>
                <td class="filter-header">제조사</td>
                <td class="left-align">
                    <div class="options-list">
                        <div th:each="value : ${cate['LBI2']}">
                            <input type="checkbox" name="manufacturer" th:value="'LBI2_'+${value}" th:id="${value}">
                            <label th:for="${value}" th:text="${value}"></label>
                        </div>
                    </div>
                </td>
            </tr>
            <!-- 운영체제(OS) -->
            <tr>
                <td class="filter-header">운영체제(OS)</td>
                <td class="left-align">
                    <div class="options-list">
                        <div th:each="value : ${cate['LBI1']}">
                            <input type="checkbox" name="os" th:value="'LBI1_'+${value}" th:id="${value}">
                            <label th:for="${value}" th:text="${value}"></label>
                        </div>
                    </div>
                </td>
            </tr>
            <!-- 저장장치 종류 -->
            <tr>
                <td class="filter-header">저장장치 종류</td>
                <td class="left-align">
                    <div class="options-list">
                        <div th:each="value : ${cate['LS22']}">
                            <input type="checkbox" name="storageType" th:value="'LS22_'+${value}" th:id="${value}">
                            <label th:for="${value}" th:text="${value}"></label>
                        </div>
                    </div>
                </td>
            </tr>
            <!-- 저장 용량 -->
            <tr>
                <td class="filter-header">저장 용량</td>
                <td class="left-align">
                    <div class="options-list">
                        <div th:each="value : ${cate['LS21']}">
                            <input type="checkbox" name="storageCapacity" th:value="'LS21_'+${value}" th:id="${value}">
                            <label th:for="${value}" th:text="${value}"></label>
                        </div>
                    </div>
                </td>
            </tr>
            <!-- GPU 종류 -->
            <tr>
                <td class="filter-header">GPU 종류</td>
                <td class="left-align">
                    <div class="options-list">
                        <div th:each="value : ${cate['LG38']}">
                            <input type="checkbox" name="gpu" th:value="'LG38_'+${value}" th:id="${value}">
                            <label th:for="${value}" th:text="${value}"></label>
                        </div>
                    </div>
                </td>
            </tr>
            <!-- CPU 종류 -->
            <tr>
                <td class="filter-header">CPU 종류</td>
                <td class="left-align">
                    <div class="options-list">
                        <div th:each="value : ${cate['LC13']}">
                            <input type="checkbox" name="cpu" th:value="'LC13_'+${value}" th:id="${value}">
                            <label th:for="${value}" th:text="${value}"></label>
                        </div>
                    </div>
                </td>
            </tr>
            <!-- 램 용량 -->
            <tr>
                <td class="filter-header">램 용량</td>
                <td class="left-align">
                    <div class="options-list">
                        <div th:each="value : ${cate['LR9']}">
                            <input type="checkbox" name="ram" th:value="'LR9_'+${value}" th:id="${value}">
                            <label th:for="${value}" th:text="${value}"></label>
                        </div>
                    </div>
                </td>
            </tr>
            <!-- 해상도 -->
            <tr>
                <td class="filter-header">해상도</td>
                <td class="left-align">
                    <div class="options-list">
                        <div th:each="value : ${cate['LD25']}">
                            <input type="checkbox" name="resolution" th:value="'LD25_'+${value}" th:id="${value}">
                            <label th:for="${value}" th:text="${value}"></label>
                        </div>
                    </div>
                </td>
            </tr>
            <!-- 가격대 -->
            <tr>
                <td class="filter-header">가격대</td>
                <td class="left-align">
                    <div class="options-list">
                        <div class="price-search">
                            <input type="number" id="site-search1" name="min" style="width: 100px;" />
                            ~
                            <input type="number" id="site-search2" name="max" style="width: 100px;" />
                            <button type="button" id="priceSearch" name="prices" class="btn-custom-price" onclick="searchProducts()">검색</button>
                        </div>
                    </div>
                </td>
            </tr>
            </tbody>
        </table>
    </form>
    <br>
    <form th:action="@{/product/search}" method="get" id="searchForm" name="search-form">
        <div class="product-search">
            <div class="form-outline" data-mdb-input-init>
                <input type="search" id="form1" class="form-control search-input" placeholder="검색어를 입력하세요." name="keyword"/>
            </div>
            <button type="submit" class="btn btn-primary-input" data-mdb-ripple-init>
                <i class="fas fa-search"></i>
            </button>
        </div>
        <input type="hidden" id="typeNo" name="typeNo" value="1"/>
    </form>
    <div>
        <ul class="nav nav-tab product-taps flex-grow-1">
            <li class="nav-item product-item">
                <a class="nav-link product-link" id="laptop-tab" data-type-no="1" href="#">노트북</a>
            </li>
            <li class="nav-item product-item">
                <a class="nav-link product-link" id="mouse-tab" data-type-no="2" href="#">마우스</a>
            </li>
            <li class="nav-item product-item">
                <a class="nav-link product-link" id="keyboard-tab" data-type-no="3" href="#">키보드</a>
            </li>
        </ul>
    </div>
    <br>
    <div class="row" id="product-list"></div>
</div>
</body>
</html>
